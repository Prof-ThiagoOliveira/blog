---
title: From prototype to production, choosing the right R and C++ tool in Rcpp
author: Thiago de Paula Oliveira
date:  "`r format(Sys.Date(), '%B %d, %Y')`"
slug: rcpp-start-with-r
categories:
  - R Programming
  - Data handling
tags:
  - C++
  - Rcpp
  - R
subtitle: ''
summary: 'what each tool solves, when to reach for it, and ready-to-paste code.'
authors: 
- admin
lastmod: '2025-08-06T09:15:54Z'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
output:
  html_document:
    keep_md: yes
    toc: true
---



#  Prototype at light-speed with **inline**

`inline::cxxfunction()` compiles, links and returns an `R` function from a character string, ideal for quick sketches or teaching. 

```{r}
library(inline)
library(Rcpp)

src <- '
  // Declare two Rcpp numeric vectors, populated from the R arguments `a` and `b`
  Rcpp::NumericVector xa(a), xb(b);

  // Cache the lengths of those vectors in plain C++ ints for fast reuse
  int na = xa.size(), nb = xb.size();

  // Pre-allocate the output vector, with length (na + nb ‚àí 1) for a full 
  // discrete convolution
  Rcpp::NumericVector out(na + nb - 1);

  // Walk over every element of the first vector
  for (int i = 0; i < na; ++i)
    // Multiply the i-th element of `a` with every element of `b`
    for (int j = 0; j < nb; ++j)
        // Accumulate the product at the correct lag/index in the result
        out[i + j] += xa[i] * xb[j];

  // Return the filled result vector back to R
  return out;
'

conv <- cxxfunction(signature(a = "numeric", b = "numeric"),
                    body = src, plugin = "Rcpp")
conv(1:4, 2:5)
#> [1]  2  7 16 30 34 31 20
```

Choose **inline** when:

* you need an answer *now* without creating extra files;
* you are benchmarking or exploring an API shape;
* you want to inject ad-hoc `#include` blocks or compiler flags.

## Level-up with plugins and **Rcpp attributes**

### 4.1 Plugins

Plugins bolt extra headers and libraries onto an `inline` or attributes build‚Äîno manual `-I`/`-L` juggling.
The built-in `RcppArmadillo` plugin lets you write BLAS-backed linear algebra on the fly:

```{r}
library(RcppArmadillo)
src <- '
  // Armadillo + Rcpp headers are supplied automatically by the plugin
  using namespace Rcpp;

  /* ---- 1. Map the inputs -------------------------------------------------- */
  Rcpp::NumericVector  yr_(yr);            // wrap SEXP as NumericVector
  Rcpp::NumericMatrix  Xr_(Xr);            // wrap SEXP as NumericMatrix

  int n = Xr_.nrow();                      // rows  = #obs
  int k = Xr_.ncol();                      // cols  = #predictors

  // zero-copy Armadillo views
  arma::colvec y( yr_.begin(), yr_.size(), false );
  arma::mat    X( Xr_.begin(), n, k,       false );

  /* ---- 2. OLS -------------------------------------------------------------- */
  arma::colvec coef = arma::solve(X, y);
  arma::colvec res  = y - X * coef;
  double s2         = arma::dot(res, res) / (n - k);
  arma::colvec se   = arma::sqrt( s2 * arma::diagvec( arma::inv(X.t() * X) ) );

  /* ---- 3. Ship results back to R ------------------------------------------ */
  return List::create(_["coef"] = coef,
                      _["se"]   = se,
                      _["df"]   = n - k);
'

fastLm <- cxxfunction(signature(yr = "numeric", Xr = "numeric"),
                      body   = src,
                      plugin = "RcppArmadillo")

# Usage 
set.seed(123)

n <- 1000
k <- 3
X <- cbind(1, matrix(rnorm(n * k), n, k))  # 1st col = intercept
beta  <- c(5, 0.8, -1.2, 0.5)                 # true coefficients
y  <- X %*% beta + rnorm(n, sd = 2)           # synthetic data
res <- fastLm(y, X)
str(res)

fit <- lm(y ~ X[,2] + X[,3] + X[,4])  # lm() adds its own intercept

cbind(fastLm = res$coef,
      lm     = coef(fit))

microbenchmark::microbenchmark(
  fastLm = fastLm(y, X),
  lm     = { lm(y ~ X[,2] + X[,3] + X[,4]) },
  times  = 100
)
```


### 4.2 Rcpp Attributes

* Attributes internalise *inline*‚Äôs magic behind `[[Rcpp::export]]`.
* `sourceCpp()` compiles a file; 
* `cppFunction()` compiles from a string; 
* `evalCpp()` runs an expression, all while caching builds transparently.

```{r}
cpp_src <- paste(
  '#include <Rcpp.h>',
  'using namespace Rcpp;',
  '',
  '// [[Rcpp::export]]',
  'int fibonacci(int x) {',
  '  return (x < 2) ? x : fibonacci(x - 1) + fibonacci(x - 2);',
  '}',
  sep = "\n"
)
writeLines(cpp_src, "fibonacci.cpp")   # main copy
```

```{r}
Rcpp::sourceCpp("fibonacci.cpp")
fibonacci(20)     #> 6765
```

Use attributes for almost everything once you move beyond exploratory work.


## Quick decision guide

| Task                                              | Reach for ‚Ä¶                                                                           |
| ------------------------------------------------- | ------------------------------------------------------------------------------------- |
| Package / production code                         | **Rcpp Attributes**                                                                   |
| One-off sketches, benchmarks, Stack Overflow post | **inline::cxxfunction()**                                                             |
| Extra C++ libraries (Armadillo, Eigen, GSL, ...)    | **Plugins** (built-in or custom)                                                      |
| Low-level debugging with `gdb`                    | Manual `R CMD SHLIB` + helper flags                                                   |
| Propagate C++ exceptions cleanly                  | Ensure `BEGIN_RCPP/END_RCPP` are present (added automatically by `inline` / Attributes) |

---

## Take-aways

* **Match R‚Äôs compiler** or live with hard-to-trace crashes.
* **`.Call()` via Rcpp** is the modern native interface‚Äîtype, which is safe and header-driven.
* **inline** and **Attributes** shrink the compile‚Äìlink‚Äìload loop to a single line.
* **Plugins** keep code portable while tapping heavy `C++` libraries.
* **BEGIN\_RCPP/END\_RCPP** keep your` C++` errors readable from R.


**Did you find this page helpful? Consider sharing it üôå**


<style>
/* Let the outer wrapper use the full viewport width */
.page-body > .mx-auto{
  max-width: 100vw !important;
  padding-left: 0 !important;
  padding-right: 0 !important;
}

/* Let the main column use all available space (beats Tailwind max-w-6xl) */
.page-body article > main{
  max-width: 100% !important;
}

/* Widen the reading column while keeping lines readable */
.page-body article .prose{
  max-width: 92ch !important;   /* tweak to taste: 80‚Äì105ch */
  margin-inline: auto;
  font-size: 1.075rem;
  line-height: 1.75;
  text-align: left;
}

/* Phones: full width with comfy padding */
@media (max-width: 768px){
  .page-body article .prose{
    max-width: 100% !important;
    padding-inline: 1rem;
  }
}

/* Optional: make sidebars slimmer on XL screens */
@media (min-width: 1280px){
  .hb-sidebar-container, .hb-toc { width: 12rem !important; } /* was 16rem */
}

/* Minimal type polish */
.page-body article .prose h1{
  font-size: 2.1rem;
  margin: 1.2em 0 .5em;
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: .3em;
}
.page-body article .prose h2{
  font-size: 1.5rem;
  margin: 1.35em 0 .4em;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: .2em;
}
.page-body article .prose pre{
  background: #f6f8fa;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px 14px;
  overflow: auto;
}
.page-body article .prose code{
  background: #f6f8fa;
  border: 1px solid #e5e7eb;
  border-radius: 5px;
  padding: .15em .35em;
  font-size: .95em;
}
html.dark .page-body article .prose pre,
html.dark .page-body article .prose code{
  background: #111826;
  border-color: #253041;
}
</style>

<style>
/* ====== Post-only layout + typography polish (Hugo Blox / Tailwind) ====== */
/* Place this at the very end of the post so it wins the cascade. */

/* 0) Widen the page shell Hugo Blox uses around articles */
.page-body > .mx-auto,
.page-body .max-w-screen-xl{
  max-width: 100vw !important;
  width: 100% !important;
  padding-left: 0 !important;
  padding-right: 0 !important;
}

/* 1) Remove the Tailwind max-w cap on the <main> inside <article> */
.page-body article > main{
  max-width: none !important;  /* beats .max-w-6xl */
  width: 100% !important;
}

/* 2) Control the actual reading width (fluid per breakpoint) */
.page-body article .prose{
  /* Base: a touch larger with comfy line height */
  font-size: clamp(1rem, 0.96rem + 0.25vw, 1.12rem);
  line-height: 1.75;
  text-align: left;
  margin-inline: auto;

  /* Reading width: scale up on big screens, but keep lines readable */
  max-width: 86ch !important; /* default desktop */
}
@media (min-width: 1024px){  /* lg */
  .page-body article .prose{ max-width: 96ch !important; }
}
@media (min-width: 1280px){  /* xl */
  .page-body article .prose{ max-width: 102ch !important; }
}
@media (min-width: 1536px){  /* 2xl / very wide */
  .page-body article .prose{ max-width: 108ch !important; }
}

/* 3) Phones/tablets: full width with side padding */
@media (max-width: 768px){
  .page-body article .prose{
    max-width: 100% !important;
    padding-inline: 1rem;
  }
}

/* 4) Give the article more room by slimming sidebars on wide screens */
@media (min-width: 1280px){
  .hb-sidebar-container, .hb-toc { width: 12rem !important; } /* was 16rem */
}
@media (max-width: 1279.98px){
  .hb-sidebar-container{ display:none !important; } /* hide sidebar under xl */
}

/* --------- Clean, professional type polish (scoped to post content) -------- */
.page-body article .prose p{
  margin: 0 0 1.15em;
  text-wrap: pretty;
  hyphens: auto;
}

.page-body article .prose h1{
  font-size: clamp(1.9rem, 1.6rem + 1.2vw, 2.3rem);
  margin: 1.2em 0 .5em;
  padding-bottom: .25em;
  border-bottom: 2px solid #e5e7eb;
}
.page-body article .prose h2{
  font-size: clamp(1.4rem, 1.2rem + 0.6vw, 1.7rem);
  margin: 1.35em 0 .4em;
  padding-bottom: .2em;
  border-bottom: 1px solid #e5e7eb;
}
.page-body article .prose h3{
  font-size: clamp(1.15rem, 1.05rem + 0.35vw, 1.35rem);
  margin: 1.1em 0 .3em;
}

/* Links: subtle underline-on-hover */
.page-body article .prose a{
  color: #2f6ab5;
  text-decoration: none;
  border-bottom: 1px solid rgba(47,106,181,.25);
}
.page-body article .prose a:hover{
  color: #1f4f8f;
  border-bottom-color: currentColor;
}

/* Code blocks & inline code */
.page-body article .prose pre{
  background: #f6f8fa;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px 14px;
  overflow: auto;
}
.page-body article .prose code{
  background: #f6f8fa;
  border: 1px solid #e5e7eb;
  border-radius: 5px;
  padding: .15em .35em;
  font-size: .95em;
}
.page-body article .prose pre code{
  background: none; border: 0; padding: 0; font-size: 0.95em;
}

/* Tables */
.page-body article .prose table{
  width: 100%;
  border-collapse: collapse;
  margin: 1.2rem 0;
  font-variant-numeric: tabular-nums;
}
.page-body article .prose th,
.page-body article .prose td{
  border: 1px solid #e5e7eb;
  padding: .6rem .75rem;
}
.page-body article .prose thead th{
  background: #2f6ab5;
  color: #fff;
  text-align: left;
}

/* Images & figures */
.page-body article .prose img{ border-radius: 6px; }

/* Optional: allow ‚Äúfull-bleed‚Äù wide elements
   Add class="wide" to a block (table/pre/img wrapper) to span the viewport. */
.page-body article .prose .wide{
  width: 100vw;
  position: relative;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;
  padding-inline: clamp(12px, 4vw, 36px);
}

/* Footer timestamp spacing */
.page-body article time{ margin-top: 2rem; display: block; }

/* Dark mode tweaks */
html.dark .page-body article .prose pre,
html.dark .page-body article .prose code{
  background: #111826;
  border-color: #253041;
}
html.dark .page-body article .prose thead th{ background: #5aa0ff; }
</style>
