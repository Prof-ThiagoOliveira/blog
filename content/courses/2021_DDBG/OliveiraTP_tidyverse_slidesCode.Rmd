---
title: "Tidyverse: R code"
subtitle: "Principles of graph grammar and tidy data"
author: "Thiago de Paula Oliveira"
date: "`r Sys.Date()`"
weight: 50
highlight: true
header-includes:
  - \usepackage{amsmath}
output:
  bookdown::html_page:
    fig_caption: true
    number_sections: true
    df_print: paged
    mathjax: "default"
    highlight: kate
    toc: true
    toc_depth: 2
    css: "my_style.css"
    dev: "svg"
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri(file.path(".", "logo.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:2px; 
               height:120px; width:220px')
```

```{r setup, include=FALSE}
# Configuring global parameters
knitr::opts_chunk$set(echo = TRUE, message = FALSE, error=FALSE, warning = FALSE,
                      fig.align = "center", fig.height = 6, fig.width = 6,
                      class.source = "lineAnchors")
```


```{r, include=FALSE, message=FALSE, error=FALSE, warning=FALSE}
#=======================================================================
# Packages
#=======================================================================
if (!require("pacman")) {
  install.packages("pacman")
}
# Include all packages here
pacman::p_load(
  knitr,
  tidyverse,
  kableExtra, 
  prettycode,
  formattable,
  DT,
  AlphaSimR,
  patchwork, # ggplot design
  tufte, # quotes
  ggridges,
  pathwork,
  ggpmisc,
  egg,
  datarium,
  tools
)
prettycode::prettycode()
```

All code I used to build the slides can be found here. Making data and code available as supplementary material promotes transparency and reproducibility, enabling anyone to reproduce the methodology discussed during the lecture.

# Data Structure

## Pivoting: 'long form'

```{r}
dataEx1 <- readRDS("./data/dataEx1.RDS")


dataEx1.1 <- dataEx1 %>%
  rownames_to_column(var = "Farm") %>%
  pivot_longer(cols = 2:4, names_to = "Income", values_to = "Freq")
```

## Pivoting: 'wide form'

```{r, pivot_wide}
dataEx2 <- as_tibble(readRDS("./data/dataEx2.RDS"))

dataEx2.2 <- dataEx2 %>%
  pivot_wider(values_from = value, names_from = type)

I <- dataEx2 %>%
  pivot_wider(values_from = value, names_from = type) %>%
  transform(id = str_replace(id,"Ind",""))
```


## Filter

```{r filter}
cbp <- readRDS("./data/animal_sim.RDS")

threshold <- with(cbp, mean(phenotype) + 2*sd(phenotype))
cbp %>%
  filter(herd %in% c("A", "E")) %>%
  filter(year == "9" & phenotype > threshold) %>%
  ggplot(aes(y = phenotype, x = sex)) +
  geom_violin() +
  geom_jitter(shape = 1, width = 0.15)

cbp %>%
  filter(herd %in% c("A", "E")) %>%
  filter(year == "9" & (phenotype > threshold | sex == "F")) %>%
  ggplot(aes(y = phenotype, x = sex)) +
  geom_violin() +
  geom_jitter(shape = 1, width = 0.15)
ggsave("filterData2.pdf", width = 4, height = 4)
```


## Distinct

```{r distinct}
cbp %>%
  distinct(dplyr::across(contains("r")))

cbp %>%
  distinct(sex)
```
## Slice

```{r slice}
cbp %>% slice(1:3)

cbp %>% slice((n()-5L):n())

cbp %>% slice_sample(n = 5)

cbp %>% slice_min(phenotype, n = 3)
```

## Arrange
```{r}
cbp %>% arrange(desc(phenotype)) %>% slice_head(n=5)
cbp %>% arrange(desc(herd)) %>% slice_head(n=5)
cbp %>% arrange(sex, phenotype, herd) %>% slice_head(n=7)
cbp %>% arrange(herd, phenotype, sex) %>% slice_head(n=7)
```
## Add row

```{r}
df <- tibble(x = 1:4, y = 20:23)
df %>% add_row(x = 3, y =21)

df %>% add_row(x = 3, y =21, .before = 4)

df %>% add_row(x = 3, .before = 4)
```
## Pull

```{r}
df %>% pull(var = x)
df %>% pull(var = x) %>% sum()
```
## Select

```{r}
cbp %>%
  select(ind:mother) %>% slice_head(n=5)

cbp %>%
  select(starts_with(c("p","m"))| ends_with("r")) %>% 
  slice_head(n=5)

cbp %>%
  select(starts_with(c("p","m")) & !ends_with("r")) %>% 
  slice_head(n=5)

cbp %>% select(contains("a")) %>% slice_head(n=5)
```

## Relocate

```{r relocate}
cbp %>%
  relocate(mother, .before = father) %>%
  relocate(year, herd, .after = sex)

cbp %>%
  relocate(where(is.factor), 
           .after = last_col())
```

## Mutate

```{r}
cbp %>% select(sex, phenotype) %>%
  dplyr::mutate(logPheno = log10(phenotype)) %>% 
  slice_head(n=5)

cbp %>% select(sex, phenotype) %>%
  dplyr::mutate(rankPheno = min_rank(desc(phenotype))) %>%
  dplyr::arrange(rankPheno) %>% slice_head(n=5)

cbp %>%
  dplyr::mutate(dplyr::across(!phenotype, as.factor))%>% 
  dplyr::mutate(phenotype = NULL) %>%
  slice_head(n=5)

cbp %>% select(sex, herd, phenotype) %>%
  dplyr::mutate(herdSex = sex:herd) %>%
  relocate(herdSex, .before = phenotype) %>% 
  slice_head(n=5)
```
## Transmute

```{r}
cbp %>% select(sex, phenotype) %>%
  dplyr::transmute(logPheno = log10(phenotype)) %>% 
  slice_head(n=5)

cbp %>% select(sex, phenotype) %>%
  dplyr::transmute(rankPheno = min_rank(desc(phenotype))) %>%
  dplyr::arrange(rankPheno) %>% slice_head(n=5)

cbp %>%
  dplyr::transmute(dplyr::across(!phenotype, as.factor))%>% 
  dplyr::mutate(phenotype = NULL) %>%
  slice_head(n=5)

cbp %>% select(sex, herd, phenotype) %>%
  dplyr::transmute(herdSex = sex:herd) %>%
  slice_head(n=5)
```
## Across

```{r across}
cbp %>%
  dplyr::mutate(across(phenotype, round, 2))

# Centering variable
fun <- function(x, na.rm = TRUE){
  x - mean(x, na.rm = na.rm)
}
cbp %>%
  dplyr::mutate(year2 = as.numeric(year)-1) %>%
  dplyr::mutate(across(c(year2, phenotype), fun))
```

## Rename

```{r}
cbp %>%
  rename(Pheno = phenotype) %>% slice_head(n=5)

cbp %>%
  rename_with(~(toupper(gsub("r", "r2", .x, fixed = TRUE)))) %>%
  slice_head(n=5)
```

## Group by

```{r}
# Centering variable
fun <- function(x, na.rm = TRUE){
  x - mean(x, na.rm = na.rm)
}
cbp %>%
  group_by(herd) %>%
  dplyr::mutate(year2 = as.numeric(year)-1) %>%
  dplyr::mutate(across(c(year2, phenotype), fun))

```


# Statistics Summary

## Summarise

```{r summarise}
s1 <- cbp %>%
  group_by(year, sex, herd) %>%
  summarise(
    mean = mean(phenotype),
    median = median(phenotype),
    min = min(phenotype),
    max = max(phenotype),
    IQR = IQR(phenotype),
    sd = sd(phenotype),
    var = sd^2,
    n = n()
  ) %>%
  dplyr::mutate(across(where(is.numeric), round,1))

s1 %>%
  ggplot(aes(y=mean, x =year)) +
  geom_point(aes(shape =herd, colour = herd)) +
  facet_wrap(~sex) +
  labs(x = "Generation", y = "Milk Yield (kg/day",
       colour = "Herd", shape = "Herd") +
  theme_bw(base_size = 13)
ggsave("milk.pdf", width = 5, height = 3)
```

```{r summarise2}
s1 %>%
  filter(year %in% c("8","9") & 
           max > 76 & min >40)


s1 %>%
  filter(year %in% c("8","9") & 
           max > 76 & min >40) %>%
  transmute(CV = sd / mean, 
            CV = scales::percent(CV)) %>%
  dplyr::mutate(across(where(is.numeric), round,1))
```
